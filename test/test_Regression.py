import unittest
import numpy as np
import sparseSpACE
from sparseSpACE.StandardCombi import *
from sparseSpACE.Grid import *
from sparseSpACE.GridOperation import DensityEstimation
from sparseSpACE.GridOperation import Regression
from sparseSpACE.ErrorCalculator import ErrorCalculatorSingleDimMisclassificationGlobal, ErrorCalculatorSingleDimVolumeGuided
from sparseSpACE.spatiallyAdaptiveSingleDimension2 import SpatiallyAdaptiveSingleDimensions2

import numpy as np
from matplotlib import pyplot as plt


class TestRegression(unittest.TestCase):

    def load_gaussian(self):
        return np.array([[0.1630789480756739, 0.9178538625991981],
                         [0.4439144641848628, 0.26413603792691953],
                         [0.7932133533747047, 0.3431404980740569],
                         [0.05998795436733462, 0.5603380630559391],
                         [0.4120679178855182, 0.742285965423333],
                         [0.7324459833386452, 0.5684163595740194],
                         [0.10131715855168533, 0.4996009440333462],
                         [0.7618451465172209, 0.8063819353242074],
                         [0.513122206246307, 0.30506007606670527],
                         [0.30412198308268557, 0.9251996368442296],
                         [0.7739982054045755, 0.6771218220821784],
                         [0.4653819309889886, 0.803577070556371],
                         [0.5575345575122804, 0.6826946170951348],
                         [0.5392083438529892, 0.9785177058833026],
                         [0.9763909611140713, 0.7037175409006861],
                         [0.5225109276091235, 0.17992621760067506],
                         [0.8569748189483573, 0.8666811583719015],
                         [0.4516077469478962, 0.13594877047168374],
                         [0.8968894781114114, 0.5694393934009226],
                         [0.4854875065658095, 0.9477353551267316],
                         [0.5371004502418786, 0.8114206857496978],
                         [0.07312085169999094, 0.2332132263420177],
                         [0.5854483174522608, 0.19258751891503212],
                         [0.6239581236587243, 0.06804091172819482],
                         [0.9399869342081955, 0.24274279200632287],
                         [0.9139925410241666, 0.035581660845489305],
                         [0.5577949338965801, 0.5056399770966495],
                         [0.5980413035780731, 0.8702206347857221],
                         [0.11643721344102953, 0.588109003420811],
                         [0.36242123096643564, 0.8237093474766528],
                         [0.4150311334650849, 0.6513006409109601],
                         [0.8370163231684999, 0.7947831563958007],
                         [0.8872026957080105, 0.09309197579992656],
                         [0.06533050857971978, 0.7442727784463372],
                         [0.8440555339357494, 0.7726331705906225],
                         [0.150213181758459, 0.3173381522246763],
                         [0.8140606917162467, 0.10210433860514134],
                         [0.6533097169549077, 0.7938139919445056],
                         [0.6374702610333317, 0.641286550352691],
                         [0.3729575725248566, 0.719304575470151],
                         [0.8550361796472539, 0.999429527410246],
                         [0.8592852915274177, 0.24413413892627933],
                         [0.2671485479144843, 0.8379190035438081],
                         [0.9112228715075714, 0.8796188286958037],
                         [0.5108579395553972, 0.6343438566080623],
                         [0.26622026196033377, 0.26350088996329946],
                         [0.41264607141205734, 0.31078501347567],
                         [0.4089670605642004, 0.8065633981678616],
                         [0.9081499809750128, 0.933157176846732],
                         [0.32607946844860347, 0.7035897756608036],
                         [0.8239098365357057, 0.8912682032700712],
                         [0.5147880614692647, 0.29001000570081403],
                         [0.7930617801737346, 0.5162767817777413],
                         [0.5383621892033309, 0.46627315315434137],
                         [0.8782386047118445, 0.26275363768211146],
                         [0.31045744528115227, 0.27640336821437983],
                         [0.6262677894308999, 0.9228351349947319],
                         [0.3360454765758587, 0.01908533533943213],
                         [0.42600004570951655, 0.9210312036329343],
                         [0.9862626866761636, 0.5584392356865182],
                         [0.05057896592111044, 0.14385919213509157],
                         [0.06595490980790075, 0.20079033302168436],
                         [0.31833351865765513, 0.05997448938531791],
                         [0.4849113669129457, 0.021576345923258855],
                         [0.7957659581474097, 0.5564379323615466],
                         [0.09850609909402719, 0.9128656611319877],
                         [0.10620169900898169, 0.016550257122252],
                         [0.45309771433384194, 0.3776632371376434],
                         [0.5431697135508189, 0.8529330489661695],
                         [0.2534383898147843, 0.1790586230395631],
                         [0.038418390807229974, 0.9646741891614736],
                         [0.924530515315517, 0.9249049269809524],
                         [0.19435582765165849, 0.819181431887406],
                         [0.2889725302980374, 0.1085772298796448],
                         [0.18394504957583857, 0.9279615643238964],
                         [0.17028141422210685, 0.7331207748937113],
                         [0.5124012575235642, 0.3392152045667519],
                         [0.13305573570874663, 0.11583232440196423],
                         [0.4193701233970768, 0.5627537970552139],
                         [0.7452268622123779, 0.6767194322211854],
                         [0.5297067710405846, 0.16779087679686755],
                         [0.9138061318814636, 0.6547208895097284],
                         [0.698004568112724, 0.15500946543051808],
                         [0.30718132605551185, 0.7600390591917145],
                         [0.18853990625115002, 0.1434770685988479],
                         [0.2818378776195404, 0.09378878371527544],
                         [0.7744889003496455, 0.6270023946512585],
                         [0.7834214777316649, 0.16860444428625043],
                         [0.31578101919079293, 0.24748581395483293],
                         [0.39469843462768817, 0.9203130363420208],
                         [0.1570918998168671, 0.8721950173523025],
                         [0.900855412462023, 0.583192870768311],
                         [0.9202115905057499, 0.5641196083085069],
                         [0.274485634003367, 0.30175649924957726],
                         [0.6731380835138547, 0.5371494412344135],
                         [0.13178319590012932, 0.24218671487159016],
                         [0.9732869232552844, 0.5133405053044506],
                         [0.34781788917841194, 0.9491337640026271],
                         [0.9156087073349808, 0.4633841307447638],
                         [0.11514038517595615, 0.11771146618022821],
                         [0.4520900814319888, 0.34326293694139143],
                         [0.6027836784174642, 0.5169027008274344],
                         [0.7701293323408923, 0.12746598436782097],
                         [0.7911044924587693, 0.06930048126933996],
                         [0.7950460851617613, 0.9767531592459368],
                         [0.46650235554059327, 0.6708566011252662],
                         [0.9384859981403297, 0.5319309583661624],
                         [0.37422662545078245, 0.18399692020370773],
                         [0.24646668855232556, 0.8662180550827608],
                         [0.6165552036188785, 0.010253220740977231],
                         [0.9878838997077943, 0.170919477644219],
                         [0.8181384849974651, 0.08773778786732034],
                         [0.46151709059385415, 0.038013608829558065],
                         [0.7115670930989799, 0.8770597962821306],
                         [0.2989351947947405, 0.05420879952204716],
                         [0.23146592163039048, 0.6646379181084143],
                         [0.6357809933326344, 0.5250159197182942],
                         [0.3516566271965845, 0.2256629815541754],
                         [0.12258433670717617, 0.16925068313552794],
                         [0.9747276700868023, 0.24218921868128795],
                         [0.8034416815463885, 0.25556513445506657],
                         [0.3067599604077579, 0.7545355228610611],
                         [0.9717716437197659, 0.31391188405597603],
                         [0.1101970694566149, 0.3520650456636064],
                         [0.2938166789849207, 0.72884974375951],
                         [0.6051386656857906, 0.8818311076835521],
                         [0.38503777896438507, 0.2592575844435874],
                         [0.11416997509397264, 0.3390084591462855],
                         [0.7581778023746388, 0.9618063086817907],
                         [0.1005645912960964, 0.03440639879970575],
                         [0.5633387360992596, 0.7353706576541633],
                         [0.055274560715845356, 0.7127567111833057],
                         [0.9533504840043124, 0.7340472946244209],
                         [0.33216302205024917, 0.6399496026356211],
                         [0.9525857342498132, 0.3013335336735471],
                         [0.9357618672704415, 0.32397322896854786],
                         [0.9762696191998285, 0.7986905078639567],
                         [0.40258674097107294, 0.5055212714141892],
                         [0.43788319489442673, 0.6688026441480083],
                         [0.20062807469327137, 0.8944709915767689],
                         [0.09347000954670515, 0.9522880379405159],
                         [0.6811754849526965, 0.6582636819271283],
                         [0.7734777077248222, 0.8416602840786348],
                         [0.8601143264124833, 0.2977962492034194],
                         [0.3965633437294459, 0.050886434583133355],
                         [0.3520126571108735, 0.6738551012976545],
                         [0.2751842211163239, 0.1577323058135841],
                         [0.3489577650557196, 0.8436951969460045],
                         [0.8897662083322686, 0.6888560713964242],
                         [0.4753109513318484, 0.9098676665300823],
                         [0.7837510781407657, 0.44778249543173176],
                         [0.6689174665214365, 0.38107643764819443],
                         [0.6604040455333919, 0.6651779444748495],
                         [0.8596981519971955, 0.6435250191605334],
                         [0.046937804662936955, 0.41978014718828116],
                         [0.012425902742192685, 0.5817042398164081],
                         [0.44831052737154964, 0.33077726152260023],
                         [0.9214640400612791, 0.0492015226209751],
                         [0.5473357287512572, 0.12293266775282696],
                         [0.019356203974786546, 0.3150016964855884],
                         [0.8280898607261399, 0.5183778326264848],
                         [0.14563607991254435, 0.8398405370035251],
                         [0.11440660457233487, 0.22338809270271776],
                         [0.4760299417789666, 0.6538709456637432],
                         [0.5365823582637708, 0.686185829199218],
                         [0.15128671424007878, 0.997827525675329],
                         [0.4771603426371753, 0.31662440532446645],
                         [0.5842956502311547, 0.6892008661827749],
                         [0.8301189620247451, 0.9633437008193113],
                         [0.8896970097320721, 0.6053868219869666],
                         [0.4993104312887595, 0.9249309412419745],
                         [0.702086610711781, 0.5532180996462407],
                         [0.44168912782510317, 0.23913961784923787],
                         [0.5163571448267867, 0.4845245212143051],
                         [0.7906310988371611, 0.48756170319537084],
                         [0.4685086553989204, 0.7001784461588519],
                         [0.713201342088934, 0.7756550694555995],
                         [0.5106789953878995, 0.8745662324260346],
                         [0.7800222722886958, 0.3254847299838627],
                         [0.05020907954788423, 0.32910713597048824],
                         [0.2085943586230884, 0.6599460243894804],
                         [0.2549320630387727, 0.8506247679787275],
                         [0.029415543442606218, 0.38773670706112506],
                         [0.4216088961363753, 0.7078758567945677],
                         [0.609800004997698, 0.08363652616560013],
                         [0.9326859928257676, 0.22828232296843798],
                         [0.08610513886119375, 0.35967934258698175],
                         [0.2764866544835324, 0.9988253903429696],
                         [0.4851955253566391, 0.8546645364245737],
                         [0.9303690844661532, 0.497855307782207],
                         [0.9591407148919944, 0.5962897889367152],
                         [0.44325119428318627, 0.22717173178327865],
                         [0.6676009438398242, 0.1164018061614146],
                         [0.142149908248971, 0.1329558675916449],
                         [0.27554059920750185, 0.2082228473944765],
                         [0.48438388429947743, 0.1266675941904385],
                         [0.19015340020317895, 0.06425136782051821],
                         [0.199112015397784, 0.9858115853142088],
                         [0.8015238189405514, 0.04620831905659195],
                         [0.3297525138069596, 0.4491224033527297]]
                        ), np.array(
            [0.056068761520337386, 0.5555626142544496, 0.3309494152119532, 0.13910686593691818, 0.5146102808192916,
             0.5559264185224597, 0.20403133926074613, 0.19704410136989883, 0.6826741208074706, 0.11173455259680928,
             0.3449100694379746, 0.39314590176608893, 0.6928959161370974, 0.09974235270973214, 0.06825586988201056,
             0.35717133569567244, 0.07288583743702114, 0.2595642335785078, 0.1972208973853044, 0.13442140408861208,
             0.3739650746527091, 0.07934023527313683, 0.3613029467770432, 0.13271614181718852, 0.07444477278589373,
             0.020842894552524166, 0.9668415664246046, 0.23067299987954165, 0.2124951579134534, 0.29020822589551903,
             0.7399919862733073, 0.1346911211109633, 0.042638372117102905, 0.08323664606510876, 0.1455798477104335,
             0.21073335006268745, 0.07656993640678161, 0.33343567467958185, 0.6780056757315162, 0.5260585545466451,
             0.02340500438030971, 0.14291108923259543, 0.18561316724402552, 0.043624033583744795, 0.83388342331019,
             0.33093015112658997, 0.6476983504020238, 0.3596294325942225, 0.028952015184845983, 0.48822862914903775,
             0.07576764753646098, 0.6420142080115747, 0.4225272208401057, 0.9742458664385506, 0.13621744833650515,
             0.42349298136632363, 0.14265429967628473, 0.07565286222495672, 0.16082593037678966, 0.09083910200864598,
             0.03732263092921858, 0.06208718628614337, 0.10370016170953827, 0.10114819136137637, 0.4038840601311354,
             0.036277626918236286, 0.02048612282311718, 0.8422645855480728, 0.2824500347426803, 0.19437617508299027,
             0.013707709870387753, 0.027114041355862588, 0.14185477364564347, 0.1384226242180011, 0.058988172441741545,
             0.19581275364109732, 0.7710088581562655, 0.05946728433812108, 0.9008719417859424, 0.40105379171231786,
             0.32875123532635436, 0.14202663275791996, 0.20551365915228026, 0.35064059244231954, 0.10633509409353482,
             0.11931089391250241, 0.40062171676501573, 0.14934331680510426, 0.3764385456446327, 0.15296981236067025,
             0.07721581687541969, 0.187109521992243, 0.16416372111429206, 0.40593097400260536, 0.7308341182013324,
             0.1325874239012002, 0.10626866584540239, 0.10552521728683126, 0.17539526498381655, 0.052727693814976676,
             0.7644347001765219, 0.8971772274628051, 0.12033033940235459, 0.06704179757856764, 0.043133398610542016,
             0.7384951803333044, 0.14472852009404955, 0.31450072994881983, 0.13752520923047135, 0.07931165141276225,
             0.03132787828323878, 0.06642231086794376, 0.11658628930323547, 0.15422429910135668, 0.09148607508383888,
             0.3707742273447201, 0.8264443105074394, 0.37807391526693457, 0.08059030395340991, 0.054023961621769784,
             0.2190944034783628, 0.3601263081851744, 0.07638471203123072, 0.17581714836547127, 0.38719080517154053,
             0.20835928906330328, 0.49079329425110374, 0.17415129545716398, 0.06085821626459584, 0.023207948016735248,
             0.552052891283846, 0.08799622659723076, 0.07404753888464881, 0.6203003861687111, 0.08689783880823004,
             0.10983914617906089, 0.042405055235122203, 0.9091926466720652, 0.7235914789236692, 0.0860945533979665,
             0.02476531919619949, 0.5606157792069715, 0.1473097062294059, 0.1816475788174008, 0.1195499067580867,
             0.5937728150488935, 0.18695392381721326, 0.24428945851418407, 0.15322572337697765, 0.1852571290937331,
             0.4349981845746197, 0.6526206570997051, 0.5885272132444348, 0.2231698994303562, 0.12039156866151789,
             0.0868093598108164, 0.7311904146583579, 0.022181159031536248, 0.2359337007041759, 0.07047985817653997,
             0.33966106900411147, 0.08975659391514171, 0.10519240905427334, 0.7846572222591573, 0.6976523827135982,
             0.024864057061500692, 0.7107158434127915, 0.6511421891421019, 0.03929495492440493, 0.19598808421398392,
             0.1643646566590736, 0.6461577282726434, 0.48944510522018914, 0.9949423668098458, 0.4290372781447694,
             0.6632315188298827, 0.29688652145018035, 0.24557840007274967, 0.33666041595240764, 0.09875014261753888,
             0.3312109533056368, 0.1604199497207981, 0.09627681213708601, 0.6104399391569179, 0.15658663648532797,
             0.0734995023164903, 0.14808209993404683, 0.05039567824201779, 0.283636707491699, 0.1568882538942773,
             0.11071242611009778, 0.459987065264666, 0.17336145880137604, 0.0722385939962459, 0.25790620830224614,
             0.24753346772812637, 0.057336500073649245, 0.03817918691400172, 0.05138366128843837, 0.7292582451496878])


    def test_Regression(self):
        """
        Test the calculated surpluses of the component grids for a combination scheme of level 4
        """

        # define data
        data, target = self.load_gaussian()

        # define operation to be performed
        operation = Regression(data, target, 0, 'C')

        levelvecs = [(1, 4), (2, 3), (3, 2), (4, 1), (1, 3), (2, 2), (3, 1)]


        alphas = {(1, 4) :
                [0.11065860427731983, 0.18959091373643364, 0.32446936991452197,
                 0.5105059842232064, 0.6810967316082102, 0.8821779924049133,
                 0.9815459958755389, 1.0723114097036743, 0.9479619418498437,
                 0.8553507114382808, 0.693478235871121, 0.4753565542687895,
                 0.30514648059221616, 0.17940127558440058, 0.09222683872880029],
                (2, 3) :
                [0.08188430128151994, 0.23638053907072593, 0.3765391016735835,
                 0.4658570289592481, 0.40551816103856053, 0.21822780776291195,
                 0.07823311310978338, 0.2000008451724555, 0.5227222253215382,
                 0.9075566926467884, 1.1432293996771659, 0.903069275791512,
                 0.49889458751654947, 0.17861159902961987, 0.09207810069867173,
                 0.19028826944411387, 0.4095026175748928, 0.4695691389793164,
                 0.3921313752788351, 0.21002006168859882, 0.07660801134621266],
                (3, 2) :
                [0.09023910619654024, 0.207037574200302, 0.0800016056047822,
                 0.19495305433542406, 0.6282744248266662, 0.17980079203414864,
                 0.4119672432459376, 0.945691613430948, 0.3893185199193364,
                 0.49947209154114924, 1.1584286986445644, 0.4481123030804201,
                 0.34540434274602166, 0.8927448016764097, 0.3936969202793994,
                 0.2162086089690396, 0.5205813216898315, 0.20994127259720188,
                 0.09279683703322048, 0.2061662726106173, 0.08228485736235669],
                (4, 1) :
                [0.11398599970433558, 0.19907100570348105, 0.29151066265347914,
                 0.46190905752234623, 0.6585114411636477, 0.8265207412726352,
                 1.0050650320026897, 1.0423270005302983, 0.9480550865323026,
                 0.8564975225271454, 0.6901887547467396, 0.49796223463039696,
                 0.3074687677696602, 0.20045755031701373, 0.1070419401841621],
                (1, 3) :
                [0.18822607588871207, 0.49558499503241976, 0.879389799041876,
                 1.0672201052419146, 0.8677271228338038, 0.4751263317414682,
                 0.1711670704255611],
                (2, 2) :
                [0.21660404145659395, 0.5449090672146288, 0.21124570606943593,
                 0.5170825512960333, 1.2133423080617338, 0.49025598945203863,
                 0.20266095074893886, 0.5012412285479785, 0.21250958180857427],
                (3, 1) :
                [0.19768155850901906, 0.43928359696459096, 0.8685527294901246,
                 1.0603772333886812, 0.857820604540198, 0.4870964657885491,
                 0.19546934478422362]}

        for i in range(len(levelvecs)):
            operation.grid.setCurrentArea(np.zeros(len(levelvecs[i])), np.ones(len(levelvecs[i])), levelvecs[i])

            alpha1 = operation.solve_regression(levelvecs[i])

            alpha2 = alphas.get(levelvecs[i])

            self.assertEqual(len(alpha1), len(alpha2))

            # Check values
            for j in range(len(alpha1)):
                self.assertAlmostEqual(alpha1[j], alpha2[j])


if __name__ == '__main__':
    unittest.main()
